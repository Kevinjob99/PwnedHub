{% extends "layout.html" %}
{% block body %}
    <div class="row">
        <div class="ten columns offset-by-one center-content">
            <form action="{{ url_for('core.messages') }}" method="post">
                <input style="float: right;" type="submit" value="submit" onclick="this.form.submit();" />
                <span style="display: block; overflow: hidden; padding-right: 10px">
                    <input style="width: 100%;" name="message" type="text" placeholder="message here..." />
                </span>
            </form>
        </div>
    </div>
    <div class="row">
        <div class="ten columns offset-by-one messages">
        {% if messages|length == 0 %}
            <div class="center-content">
                no messages
            </div>
        {% else %}
        {% for message in messages %}
            <div style="position: relative;">
            {% if message.user == g.user or g.user.is_admin %}
                <button type="button" class="delete img-btn" onclick="window.location='{{ url_for('core.messages_delete', mid=message.id) }}'"><img src="{{ url_for('static', filename='images/delete.png') }}" title="delete" /></button>
            {% endif %}
                <div{% if message.user == g.user %} style="font-weight: bold;"{% endif %}>
                    <p class="name"><span class="red">{{ message.user.name }}</span> <span style="font-size: .75em">({{ message.user.username }})</span></p>
                    <p class="message">{{ message.comment|safe }}</p>
                    <div class="scroll"></div>
                    <p class="timestamp">{{ message.created_as_string }}</p>
                </div>
            </div>
        {% endfor %}
        {% endif %}
            <div class="pagination">
                <span onclick="window.location='{{ url_for('core.messages_page', page=current_page-1) }}'"{% if current_page == 0 %} disabled="disabled"{% endif %}>prev</span>
                |
                <span onclick="window.location='{{ url_for('core.messages_page', page=current_page+1) }}'"{% if current_page >= pages-1 %} disabled="disabled"{% endif %}>next</span>
            </div>
        </div>
    </div>
    <script>
function buildUnfurl(url, data) {
    // build array of values in specific order
    var values = [];
    var keys = ["site_name", "title", "description"];
    for (var k in keys) {
        if (data[keys[k]] !== null) {
            values.push(data[keys[k]]);
        }
    }
    // return nothing if there are no values
    if (values.length === 0) {
        return '';
    }
    // create unfurl content
    var p = document.createElement("p");
    p.textContent = values.join(" | ");
    // create unfurl link (root)
    var a = document.createElement("a");
    a.href = url;
    // append content to link
    a.append(p);
    // return the root element
    return a;
}

var messages = document.getElementsByClassName("message");
var pattern = /\w+:(\/?\/?)[^\s]+/gi;
for (var i = 0; i < messages.length; i++) {
    var content = messages[i].innerHTML;
    matches = content.match(pattern);
    if (matches !== null) {
        for (var x = 0; x < matches.length; x++) {
            var url = matches[x];
            // closure required to localize parameters
            (function(i, url) {
                $.ajax({
                    url: "{{ url_for('api.unfurl') }}",
                    type: "POST",
                    data: JSON.stringify({url: url}),
                    contentType: "application/json",
                    success: function(data){
                        var content = buildUnfurl(url, data);
                        // append content to unfurl div
                        messages[i].nextElementSibling.append(content);
                    },
                    error: function(xhr) {
                        //console.log(xhr);
                    }
                });
            })(i, url);
        }
    }
}
    </script>
{% endblock %}
