{% extends "layout.html" %}
{% block body %}
<div class="row">
    <div class="col-xs-10 col-xs-offset-1">
        <div class="center-content">
            <select style="float: left;" id="tool" onchange="info(this);">
            {% for tool in tools %}
                <option value="{{ tool.id }}">{{ tool.name }}</option>
            {% endfor %}
            </select>
            <input style="float: right;" type="button" onclick="execute();" value="execute" />
            <span style="display: block; overflow: hidden; padding-left: 10px; padding-right: 10px">
                <input style="width: 100%" type="text" id="args" placeholder="command arguments..." />
            </span>
        </div>
    </div>
</div>
<div class="row grow">
    <div class="col-xs-12">
        <div class="output rounded">
            <pre id="output"></pre>
            <button type="button" class="save-as img-btn" onclick="save_artifact();"><i class="fas fa-save" title="save as artifact"></i></button>
            <div id="spinner" class="spinner"></div>
        </div>
    </div>
</div>
<script>
function info(e) {
    var tid = e.options[e.selectedIndex].value;
    // get the description
    $.ajax({
        url: "{{ url_for('api.tool_read', tid='{0}') | urldecode }}".format(tid),
        success: function(data){
            // update the textarea with the description
            document.getElementById("output").innerHTML = data.description;
        }
    });
}

function execute() {
    var spinner = document.getElementById("spinner");
    spinner.style.visibility = "visible";
    var tid = document.getElementById("tool").options[document.getElementById("tool").selectedIndex].value;
    var args = document.getElementById("args").value;
    // execute the command
    $.ajax({
        url: "{{ url_for('api.tool_execute', tid='{0}') | urldecode }}".format(tid),
        type: "POST",
        data: JSON.stringify({args: args}),
        contentType: "application/json",
        success: function(data){
            spinner.style.visibility = "hidden";
            if (data.error === true) {
                // flash error message
                show_flash(data.output);
            } else {
                // update the textarea with the command output
                document.getElementById("output").innerHTML = "$ {0}\n{1}".format(data.cmd, data.output);
            }
        }
    });
}

function save_artifact() {
    var filename = document.getElementById("tool").options[document.getElementById("tool").selectedIndex].text;
    var content = document.getElementById("output").innerHTML;
    if (confirm("Save as an artifact?") == true) {
        $.ajax({
            url: "{{ url_for('api.artifact_create') }}",
            type: "POST",
            data: "<xml><filename>"+filename+"</filename><content>"+content+"</content></xml>",
            contentType: 'application/xml',
            success: function(data){
                show_flash($(data).find("message").text());
            }
        });
    }
}

// populate the default tool's description onload
document.getElementById("tool").onchange()
</script>
{% endblock %}
