{% extends "layout.html" %}
{% block body %}
<div class="row flex-both">
    <div class="col-xs-12">
        <div class="notes">
            <textarea name="notes" id="notes">{{ notes }}</textarea>
            <button type="button" class="save-as img-btn" onclick="save_artifact();"><i class="fas fa-save" title="save as artifact"></i></button>
        </div>
    </div>
</div>
<script>
var notes = document.getElementById("notes")
var key = "{{ g.user.username|safe }}-notes";

// register an event to save the notes when focus is lost
notes.onblur = function() {
    // persist notes locally in case of a failed sync
    localStorage.setItem(key, this.value);
    // sync the notes
    $.ajax({
        url: "{{ url_for('api.note_update') }}",
        type: "PUT",
        async: false,
        data: JSON.stringify({notes: this.value}),
        contentType: "application/json",
        success: function(data){
            this.value = data.notes;
        }
    });
};

// load the local version of the notes as they will
// be the most recent in the event of a sync failure
if (localStorage.getItem(key)) {
    notes.value = localStorage.getItem(key);
    // force an attempt to sync the notes to the server
    notes.onblur();
    // should move most of this logic into the AJAX call's
    // success and error handlers to do it right
}

function save_artifact() {
    var filename = "Notes";
    var content = notes.innerHTML;
    if (confirm("Save as an artifact?") == true) {
        $.ajax({
            url: "{{ url_for('api.artifact_create') }}",
            type: "POST",
            data: "<xml><filename>"+filename+"</filename><content>"+content+"</content></xml>",
            contentType: 'application/xml',
            success: function(data){
                show_flash($(data).find("message").text());
            }
        });
    }
}
</script>
{% endblock %}
